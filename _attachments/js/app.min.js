var Utils;Utils={},Utils.addOrUpdateDesignDoc=function(e,i){var n;return n=e._id.replace(/^_design\//,""),database.get("_design/"+n,function(s,t){var r,a;return(null!=t&&null!=(r=t.views)&&null!=(a=r[n])?a.map:void 0)===e.views[n].map?i.success():(console.log("Updating design doc for "+n),t&&t._rev&&(e._rev=t._rev),database.put(e).then(function(){return i.success()}))})},Utils.createDesignDoc=function(e,i){var n;return i=_.isFunction(i)?i.toString():CoffeeScript.compile(i,{bare:!0}),n={_id:"_design/"+e,views:{}},n.views[e]={map:i},n};
var L_PREFER_CANVAS,database,databaseName;L_PREFER_CANVAS=!0,databaseName="coconut",database=PouchDB(databaseName),Backbone.sync=BackbonePouch.sync({db:database,fetch:"query"}),Backbone.Model.prototype.idAttribute="_id";
var Config,__bind=function(t,o){return function(){return t.apply(o,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,o){function n(){this.constructor=t}for(var e in o)__hasProp.call(o,e)&&(t[e]=o[e]);return n.prototype=o.prototype,t.prototype=new n,t.__super__=o.prototype,t};Config=function(t){function o(){return this.cloud_url_no_http=__bind(this.cloud_url_no_http,this),this.cloud_database_name=__bind(this.cloud_database_name,this),this.fetch=__bind(this.fetch,this),o.__super__.constructor.apply(this,arguments)}return __extends(o,t),o.prototype.initialize=function(){return this.set({_id:"coconut.config"})},o.prototype.fetch=function(t){return database.get("coconut.config",function(o){return function(n,e){return o.set(e),database.get("coconut.config.local",function(o,n){return Coconut.config.local=new Backbone.Model,Coconut.config.local.set(n),"function"==typeof t.success?t.success():void 0})}}(this))},o.prototype.title=function(){return this.get("title")||"Coconut"},o.prototype.database_name=function(){return database._db_name},o.prototype.cloud_database_name=function(){return this.get("cloud_database_name")||this.database_name()},o.prototype.cloud_url=function(){return"http://"+this.cloud_url_no_http()+"/"+this.cloud_database_name()},o.prototype.cloud_url_with_credentials=function(){return"http://"+this.get("cloud_credentials")+"@"+this.cloud_url_no_http()+"/"+this.cloud_database_name()},o.prototype.cloud_log_url_with_credentials=function(){return"http://"+this.get("cloud_credentials")+"@"+this.cloud_url_no_http()+"/"+this.cloud_database_name()+"-log"},o.prototype.cloud_url_no_http=function(){return this.get("cloud").replace(/http:\/\//,"")},o}(Backbone.Model);
var Help,__hasProp={}.hasOwnProperty,__extends=function(t,o){function r(){this.constructor=t}for(var e in o)__hasProp.call(o,e)&&(t[e]=o[e]);return r.prototype=o.prototype,t.prototype=new r,t.__super__=o.prototype,t};Help=function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return __extends(o,t),o.prototype.initialize=function(){},o.prototype.url="/help",o}(Backbone.Model);
var Question,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};Question=function(t){function e(){return this.summaryFieldNames=__bind(this.summaryFieldNames,this),this.resultSummaryFields=__bind(this.resultSummaryFields,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.set({collection:"result"})},e.prototype.type=function(){return this.get("type")},e.prototype.label=function(){return this.get(null!=this.get("label")?"label":"id")},e.prototype.safeLabel=function(){return this.label().replace(/[^a-zA-Z0-9 -]/g,"").replace(/[ -]/g,"")},e.prototype.repeatable=function(){return this.get("repeatable")},e.prototype.questions=function(){return this.get("questions")},e.prototype.value=function(){return null!=this.get("value")?this.get("value"):""},e.prototype.required=function(){return null!=this.get("required")?this.get("required"):"true"},e.prototype.validation=function(){return null!=this.get("validation")?this.get("validation"):null},e.prototype.skipLogic=function(){return this.get("skip_logic")||""},e.prototype.actionOnChange=function(){return this.get("action_on_change")||""},e.prototype.attributeSafeText=function(){var t;return t=this.get(null!=this.get("label")?"label":"id"),t.replace(/[^a-zA-Z0-9]/g,"")},e.prototype.url="/question",e.prototype.set=function(t){return null!=t.questions&&(t.questions=_.map(t.questions,function(t){return new e(t)})),null!=t.id&&(t._id=t.id),e.__super__.set.call(this,t)},e.prototype.loadFromDesigner=function(t){var n,i,r,o,u,s;if(r=e.fromDomNode(t),1===r.length){for(r=r[0],this.set({id:r.id}),s=["label","type","repeatable","required","validation"],o=0,u=s.length;u>o;o++)i=s[o],n={},n[i]=r.get(i),this.set(n);return this.set({questions:r.questions()})}throw"More than one root node"},e.prototype.resultSummaryFields=function(){var t,e,n,i;return e=this.get("resultSummaryFields"),e?e:(t=Math.min(2,this.questions().length-1),n={},_.each(function(){i=[];for(var e=0;t>=0?t>=e:e>=t;t>=0?e++:e--)i.push(e);return i}.apply(this),function(t){return function(e){var i;return n[null!=(i=t.questions()[e])?i.label():void 0]="on"}}(this)),n)},e.prototype.summaryFieldNames=function(){return _.keys(this.resultSummaryFields())},e.prototype.summaryFieldKeys=function(){return _.map(this.summaryFieldNames(),function(t){return t.replace(/[^a-zA-Z0-9 -]/g,"").replace(/[ -]/g,"")})},e}(Backbone.Model),Question.fromDomNode=function(t){return _(t).chain().map(function(){return function(t){var e,n,i,r,o,u,s,a;if(t=$(t),n=t.attr("id"),t.children("#rootQuestionName").length>0&&(n=t.children("#rootQuestionName").val()),n){for(o=new Question,o.set({id:n}),a=["label","type","repeatable","select-options","radio-options","autocomplete-options","validation","required","action_on_questions_loaded","skip_logic","action_on_change","image-path","image-style"],u=0,s=a.length;s>u;u++)i=a[u],e={},r=t.find("#"+i+"-"+n).val(),"required"===i&&(r=String(t.find("#"+i+"-"+n).is(":checked"))),null!=r&&(e[i]=r,o.set(e));return o.set({safeLabel:o.safeLabel()}),t.find(".question-definition").length>0&&o.set({questions:Question.fromDomNode(t.children(".question-definition"))}),o}}}(this)).compact().value()};
var QuestionCollection,__hasProp={}.hasOwnProperty,__extends=function(o,t){function n(){this.constructor=o}for(var e in t)__hasProp.call(t,e)&&(o[e]=t[e]);return n.prototype=t.prototype,o.prototype=new n,o.__super__=t.prototype,o};QuestionCollection=function(o){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,o),t.prototype.model=Question,t.prototype.pouch={options:{query:{include_docs:!0,fun:"questions"}}},t.prototype.parse=function(o){return _(o.rows).pluck("doc")},t.load=function(o){var n;return Coconut.questions=new t,n=Utils.createDesignDoc("questions",function(o){return o.collection&&"question"===o.collection?emit(o._id,o.resultSummaryFields):void 0}),Utils.addOrUpdateDesignDoc(n,{success:function(){return Coconut.questions.fetch({success:function(){return o.success()}})}})},t}(Backbone.Collection);
var Result,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Result=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.set({collection:"result"}),this.attributes.createdAt||this.set({createdAt:moment(new Date).format(Coconut.config.get("date_format"))}),this.attributes.lastModifiedAt?void 0:this.set({lastModifiedAt:moment(new Date).format(Coconut.config.get("date_format"))})},e.prototype.question=function(){return this.get("question")},e.prototype.tags=function(){var t;return t=this.get("Tags"),null!=t?t.split(/, */):[]},e.prototype.complete=function(){var t;return _.include(this.tags(),"complete")?!0:(t=this.get("complete"),"undefined"==typeof t&&(t=this.get("Complete")),null===t||"undefined"==typeof t?!1:t===!0||t.match(/true|yes/)?!0:void 0)},e.prototype.shortString=function(){var t;return t=this.string,t.length>40?t.substring(0,40)+"...":t},e.prototype.summaryKeys=function(t){var e;return e=t.summaryFieldKeys(),0===e.length&&(e=_.difference(_.keys(result.toJSON()),["_id","_rev","complete","question","collection"])),e},e.prototype.summaryValues=function(t){return _.map(this.summaryKeys(t),function(t){return function(e){var r;return r=t.get(e)||"","object"==typeof r&&(r=JSON.stringify(r)),r}}(this))},e.prototype.get=function(t){var r;return null==User.currentUser?null:(r=e.__super__.get.call(this,t),User.currentUser.hasRole("cleaner")?r:null!=r&&User.currentUser.hasRole("reports")&&_.contains(Coconut.identifyingAttributes,t)?b64_sha1(r):r)},e.prototype.toJSON=function(){var t;return t=e.__super__.toJSON.call(this),User.currentUser.hasRole("admin")?t:(User.currentUser.hasRole("reports")&&_.each(t,function(){return function(e,r){return null!=e&&_.contains(Coconut.identifyingAttributes,r)?t[r]=b64_sha1(e):void 0}}(this)),t)},e.prototype.save=function(t,r,n){return this.set({user:$.cookie("current_user"),lastModifiedAt:moment(new Date).format(Coconut.config.get("date_format"))}),e.__super__.save.call(this,t,r,n)},e.prototype.wasTransferredOut=function(){var t,e;return t=this.get("transferred"),null!=t&&(e=t[t.length-1].to,e!==User.currentUser.id)?!0:!1},e}(Backbone.Model);
var ResultCollection,__bind=function(e,t){return function(){return e.apply(t,arguments)}};ResultCollection=function(){function e(){this.fetch=__bind(this.fetch,this)}return e.prototype.fetch=function(e){var t,n;return n=_.extend({include_docs:!1,startkey:[e.question,e.isComplete===!0],endkey:[e.question,e.isComplete===!0,{}]},e),t=Coconut.questions.find(function(t){return t.id===e.question}).summaryFieldKeys(),database.query("results",n,function(n){return function(o,s){return n.results=_(s.rows).map(function(e){var n;return n=_.object(t,e.value),n._id=e.id,new Result(n)}),e.success()}}(this))},e.prototype.each=function(e){return _(this.results).each(e)},e.load=function(e){return Coconut.questions.fetch({error:function(e){return console.log("Error loading Coconut.questions: "+JSON.stringify(e))},success:function(){var t,n;return t={results:'(doc) ->\n  if doc.collection is "result" and doc.question and (doc.complete or doc.complete is null) and doc.createdAt\n    summaryFields = ('+Coconut.questions.map(function(e){return"if doc.question is '"+e.id+"' then "+JSON.stringify(e.summaryFieldKeys())}).join(" else ")+')\n\n    summaryResults = []\n    for field in summaryFields\n      summaryResults.push doc[field]\n\n    emit([doc.question, doc.complete is "true", doc.createdAt], summaryResults)',resultsByQuestionNotCompleteNotTransferredOut:function(e){return"result"===e.collection&&"true"!==e.complete?null!=e.transferred?emit(e.question,e.transferred[e.transferred.length-1].to):emit(e.question,null):void 0},rawNotificationsConvertedToCaseNotifications:function(e){return e.hf&&e.hasCaseNotification?emit(e.date,null):void 0}},n=_.after(_(t).size(),function(){return e.success()}),_(t).each(function(e,t){return e=Utils.createDesignDoc(t,e),Utils.addOrUpdateDesignDoc(e,{success:function(){return n()}})})}})},e}();
var Sync,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};Sync=function(t){function e(){return this.replicateApplicationDocs=__bind(this.replicateApplicationDocs,this),this.getFromCloud=__bind(this.getFromCloud,this),this.log=__bind(this.log,this),this.sendToCloud=__bind(this.sendToCloud,this),this.checkForInternet=__bind(this.checkForInternet,this),this.last_get_time=__bind(this.last_get_time,this),this.was_last_get_successful=__bind(this.was_last_get_successful,this),this.last_send_time=__bind(this.last_send_time,this),this.was_last_send_successful=__bind(this.was_last_send_successful,this),this.last_send=__bind(this.last_send,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.set({_id:"SyncLog"})},e.prototype.target=function(){return Coconut.config.cloud_url()},e.prototype.last_send=function(){return this.get("last_send_result")},e.prototype.was_last_send_successful=function(){var t;return this.get("last_send_error")===!0?!1:(t=this.last_send(),null==t?!1:null!=t.no_changes&&t.no_changes===!0?!0:t.docs_read===t.docs_written&&0===t.doc_write_failures)},e.prototype.last_send_time=function(){var t;return t=this.get("last_send_time"),t?moment(this.get("last_send_time")).fromNow():"never"},e.prototype.was_last_get_successful=function(){return this.get("last_get_success")},e.prototype.last_get_time=function(){var t;return t=this.get("last_get_time"),t?moment(this.get("last_get_time")).fromNow():"never"},e.prototype.checkForInternet=function(t){return this.log("Checking for internet. (Is "+Coconut.config.cloud_url()+" is reachable?) Please wait."),$.ajax({url:Coconut.config.cloud_url(),error:function(e){return function(n){return e.log("ERROR! "+Coconut.config.cloud_url()+" is not reachable. Do you have enough airtime? Are you on WIFI?  Either the internet is not working or the site is down: "+JSON.stringify(n)),t.error(),e.save({last_send_error:!0})}}(this),success:function(e){return function(){return e.log(""+Coconut.config.cloud_url()+" is reachable, so internet is available."),t.success()}}(this)})},e.prototype.sendToCloud=function(t){return this.fetch({error:function(t){return function(e){return t.log("Unable to fetch Sync doc: "+JSON.stringify(e))}}(this),success:function(e){return function(){return e.checkForInternet({error:function(e){return null!=t&&"function"==typeof t.error?t.error(e):void 0},success:function(){return e.log("Creating list of all results on the tablet. Please wait."),database.query("results",{},function(n,r){var o;return n?(e.log("Could not retrieve list of results: "+JSON.stringify(n)),t.error(),e.save({last_send_error:!0})):(e.log("Synchronizing "+r.rows.length+" results. Please wait."),o=_.pluck(r.rows,"id"),database.replicate.to(Coconut.config.cloud_url_with_credentials(),{doc_ids:o}).on("complete",function(n){return e.log("Success! Send data finished: created, updated or deleted "+n.docs_written+" results on the server."),e.save({last_send_result:r,last_send_error:!1,last_send_time:(new Date).getTime()}),t.success()}).on("error",function(e){return t.error(e)}))})}})}}(this)})},e.prototype.log=function(t){return Coconut.debug(t)},e.prototype.getFromCloud=function(t){return this.fetch({error:function(t){return function(e){return t.log("Unable to fetch Sync doc: "+JSON.stringify(e))}}(this),success:function(e){return function(){return e.checkForInternet({error:function(e){return null!=t&&"function"==typeof t.error?t.error(e):void 0},success:function(){return e.fetch({success:function(){return e.replicateApplicationDocs({error:function(n){return $.couch.logout(),e.log("ERROR updating application: "+JSON.stringify(n)),e.save({last_get_success:!1}),null!=t&&"function"==typeof t.error?t.error(n):void 0},success:function(){return e.save({last_get_success:!0,last_get_time:(new Date).getTime()}),null!=t&&"function"==typeof t.success&&t.success(),_.delay(function(){return document.location.reload()},5e3)}})}})}})}}(this)})},e.prototype.replicateApplicationDocs=function(t){return this.checkForInternet({error:function(e){return null!=t&&"function"==typeof t.error?t.error(e):void 0},success:function(e){return function(){return e.log("Getting list of application documents to replicate"),$.ajax({url:""+Coconut.config.cloud_url()+"/_design/coconut/_view/docIDsForUpdating",dataType:"json",include_docs:!1,error:function(e,n,r){return"function"==typeof t.error?t.error(r):void 0},success:function(n){var r;return r=_.pluck(n.rows,"id"),r=_(r).without("_design/coconut"),e.log("Updating "+r.length+" docs (users and forms). Please wait."),database.replicate.from(Coconut.config.cloud_url_with_credentials(),{doc_ids:r}).on("change",function(t){return $("#content").html("<h2> "+t.docs_written+" written out of "+r.length+" ("+parseInt(100*(t.docs_written/r.length))+"%) </h2>")}).on("complete",function(n){var r;return r=_(n).chain().map(function(t,e){return e.match(/^doc.*/)?""+e+": "+t:void 0}).compact().value(),e.log("Finished updating application documents: "+JSON.stringify(r)),"function"==typeof t.success?t.success():void 0}).on("error",function(n){return e.log("Error while updating application documents: "+JSON.stringify(n)),"function"==typeof t.error?t.error(n):void 0})}})}}(this)})},e}(Backbone.Model);
var User,UserCollection,__hasProp={}.hasOwnProperty,__extends=function(r,e){function t(){this.constructor=r}for(var o in e)__hasProp.call(e,o)&&(r[o]=e[o]);return t.prototype=e.prototype,r.prototype=new t,r.__super__=e.prototype,r};User=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,r),e.prototype.url="/user",e.prototype.username=function(){return this.get("_id").replace(/^user\./,"")},e.prototype.district=function(){return this.get("district")},e.prototype.passwordIsValid=function(r){return this.get("password")===r},e.prototype.isAdmin=function(){return _(this.get("roles")).include("admin")},e.prototype.hasRole=function(r){return _(this.get("roles")).include(r)},e.prototype.nameOrUsername=function(){return this.get("name")||this.username()},e.prototype.login=function(){return e.currentUser=this,$.cookie("current_user",this.username()),$("span#user").html(this.username()),$("#district").html(this.get("district")),$("a[href=#logout]").show(),$("a[href=#login]").hide(),this.isAdmin()?$("#manage-button").show():$("#manage-button").hide(),this.hasRole("reports")?($("#top-menu").hide(),$("#bottom-menu").hide()):void 0},e.prototype.refreshLogin=function(){return this.login()},e}(Backbone.Model),User.isAuthenticated=function(r){var e,t;return e=$.cookie("current_user"),null!=e&&""!==e?(t=new User({_id:"user."+$.cookie("current_user")}),t.fetch({success:function(){return function(){return t.refreshLogin(),r.success(t)}}(this),error:function(e){return console.error("Could not fetch user."+$.cookie("current_user")+": "+e),null!=r?r.error():void 0}})):null!=r.error?r.error():void 0},User.logout=function(){return $.cookie("current_user",""),$("span#user").html(""),$("#district").html(""),$("a[href=#logout]").hide(),$("a[href=#login]").show(),User.currentUser=null},UserCollection=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,r),e.prototype.model=User,e.prototype.url="/user",e}(Backbone.Collection);
var UserCollection,__hasProp={}.hasOwnProperty,__extends=function(t,e){function o(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};UserCollection=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.model=User,e.prototype.pouch={options:{query:{include_docs:!0,fun:"users"}}},e.prototype.parse=function(t){return _(t.rows).pluck("doc")},e.prototype.district=function(t){return t.match(/^user\./)||(t="user."+t),this.get(t).get("district")},e}(Backbone.Collection),UserCollection.load=function(t){var e,o;return Coconut.users=new UserCollection,e={users:function(t){return t.collection&&"user"===t.collection?emit(t._id,null):void 0},usersByDistrict:function(t){return t.collection&&"user"===t.collection?emit(t.district,[t.name,t._id.substring(5)]):void 0}},o=_.after(_(e).size(),function(){return Coconut.users.fetch({success:function(){return t.success()}})}),_(e).each(function(t,e){return t=Utils.createDesignDoc(e,t),Utils.addOrUpdateDesignDoc(t,{success:function(){return o()}})})};
var CsvView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};CsvView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el="#content",t.prototype.viewQuery=function(e){var t;return t=new ResultCollection,t.fetch({question:this.question,isComplete:"trueAndFalse",include_docs:!0,startTime:this.startDate,endTime:this.endDate,success:function(){return t.fields={},t.each(function(e){return _.each(_.keys(e.attributes),function(e){return _.contains(["_id","_rev","question"],e)?void 0:t.fields[e]=!0})}),t.fields=_.keys(t.fields),e.success(t)}})},t.prototype.render=function(){return this.$el.html("Compiling CSV file."),this.viewQuery({success:function(e){return function(t){var n;return n=t.map(function(e){return _.map(t.fields,function(t){var n;return n=e.get(t),(null!=n?n.indexOf('"'):void 0)?'"'+n.replace(/"/,'""')+'"':(null!=n?n.indexOf(","):void 0)?'"'+n+'"':n}).join(",")}).join("\n"),e.$el.html("<a id='csv' href='data:text/octet-stream;base64,"+Base64.encode(t.fields.join(",")+"\n"+n)+"' download='"+e.question+"-"+e.startDate+"-"+e.endDate+".csv'>Download spreadsheet</a>"),$("a#csv").button()}}(this)})},t}(Backbone.View);
var HelpView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};HelpView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el="#content",t.prototype.events={"click input[value=Send]":"send"},t.prototype.render=function(){return null!=this.helpDocument?$.ajax({url:"documentation/"+this.helpDocument+".markdown",success:function(e){return function(t){return e.$el.html(markdown.toHTML(t)),e.appendHelpForm()}}(this)}):(this.$el.html(""),this.appendHelpForm())},t.prototype.appendHelpForm=function(){return this.$el.append("<hr/> <label style='display:block' for='message'>If you are having trouble please contact your supervisor as soon as possible. You can also describe the problem in the box below and it will send a message to our support team. We'll get back to you as soon as possible.</label> <textarea style='width:100%' id='message' name='message'></textarea> <div id='messageBox'></div> </div> <input type='submit' value='Send'></input>")},t.prototype.send=function(){var e,t,n;return t=$("#message").val(),0===t.length?!1:(e=new Help({date:moment(new Date).format(Coconut.config.get("date_format")),text:t,user:User.currentUser.id.replace(/user\./,"")}),e.save(),n=new Sync,$("#messageBox").append("Attempting to 'Send Data'"),n.sendToCloud({success:function(){return $("#messageBox").append("Thank you for your feedback, it has been sent")},error:function(){return $("#messageBox").append("There was a problem sending data, but your messages has been saved. If you have connectivity you can try again by pressing the 'Send data' button at the bottom of the screen.")}}),!1)},t}(Backbone.View);
var LocalConfigView,__hasProp={}.hasOwnProperty,__extends=function(o,e){function t(){this.constructor=o}for(var n in e)__hasProp.call(e,n)&&(o[n]=e[n]);return t.prototype=e.prototype,o.prototype=new t,o.__super__=e.prototype,o};LocalConfigView=function(o){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,o),e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<form id='local-config'> <fieldset> <legend>Mode</legend> <label for='cloud'>Cloud (reporting system)</label> <input id='cloud' name='mode' type='radio' value='cloud'></input> <label for='mobile'>Mobile (data collection, probably on a tablet)</label> <input id='mobile' name='mode' type='radio' value='mobile'></input> </fieldset> <button>Save</button> <div id='message'></div> </form>"),this.$el.find("input[type=radio],input[type=checkbox]").checkboxradio(),this.$el.find("button").button(),Coconut.config.local.fetch({success:function(){return js2form($("#local-config").get(0),Coconut.config.local.toJSON())},error:function(){return $("#message").html("Complete the fields before continuing")}})},e.prototype.events={"click #local-config button":"save"},e.prototype.save=function(){var o;return o=$("#local-config").toObject(),o.mode?Coconut.config.local.save(o,{success:function(){return Coconut.router.navigate("",!1),location.reload()}}):$("#message").html("Fields incomplete"),!1},e}(Backbone.View);
var LoginView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};LoginView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<style> #login_wrapper{ font-size: 200%; width:50%; margin: 0px auto; } #login_message{ margin-top: 20px; margin-bottom: 20px; } #login_form input{ font-size: 100%; display: block; } #login_form input[type=submit]{ height: 2em; } </style> <div id='login_wrapper'> <div id='login_message'>Please login to continue:</div> <form id='login_form'> <label for='username'>Username</label> <input type='text' id='username' name='username'> <label for='password'>Password</label> <input id='password' name='password' type='password'> <input type='submit' value='Login'> </form> </div>"),$("input[type=text],input[type=password]").textinput(),$("input[type=submit]").button()},e.prototype.events={"submit form#login_form":"login"},e.prototype.updateNavBar=function(){},e.prototype.login=function(){var t,e;return t=$("#login_form").toObject(),e=new User({_id:"user."+t.username}),e.fetch({success:function(n){return function(){return e.passwordIsValid(t.password)?(e.login(),n.callback.success()):$("#login_message").html("Wrong password")}}(this),error:function(){return function(){return $("#login_message").html("Wrong username")}}(this)}),!1},e}(Backbone.View);
var MenuView,__bind=function(t,n){return function(){return t.apply(n,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,n){function e(){this.constructor=t}for(var r in n)__hasProp.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};MenuView=function(t){function n(){return this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.el=".question-buttons",n.prototype.events={change:"render"},n.prototype.render=function(){return this.$el.html("<div id='navbar' data-role='navbar'> <ul></ul> </div>"),Coconut.questions.fetch({success:function(t){return function(){return t.$el.find("ul").html(Coconut.questions.map(function(t,n){return"<li><a id='menu-"+n+"' href='#show/results/"+escape(t.id)+"'><h2>"+t.id+"<div id='menu-partial-amount'></div></h2></a></li>"}).join(" ")),$(".question-buttons").navbar(),t.update()}}(this)})},n.prototype.update=function(){return"mobile"===Coconut.config.local.get("mode")&&User.isAuthenticated({success:function(){return Coconut.questions.each(function(){return function(t,n){return database.query("resultsByQuestionNotCompleteNotTransferredOut",{key:t.id,include_docs:!1},function(t,e){var r;return t&&console.log(t),r=0,_(e.rows).each(function(t){var n;return n=t.value,null==n?r+=1:User.currentUser.id===n?r+=1:void 0}),$("#menu-"+n+" #menu-partial-amount").html(r)})}}(this))}}),database.get("version",function(t,n){return $("#version").html(t?"-":n.version)})},n}(Backbone.View);
var QuestionView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};window.SkipTheseWhen=function(e,t){var n,i,o,a,r,s,u,l;for(o=[],e=e.split(/\s*,\s*/),a=0,s=e.length;s>a;a++)i=e[a],o.push(window.questionCache[i]);for(n="disabled_skipped",l=[],r=0,u=o.length;u>r;r++)i=o[r],l.push(t?i.addClass(n):i.removeClass(n));return l},window.ResultOfQuestion=function(e){var t;return("function"==typeof(t=window.getValueCache)[e]?t[e]():void 0)||null},QuestionView=function(_super){function QuestionView(){return this.render=__bind(this.render,this),QuestionView.__super__.constructor.apply(this,arguments)}return __extends(QuestionView,_super),QuestionView.prototype.initialize=function(){return null==Coconut.resultCollection&&(Coconut.resultCollection=new ResultCollection),this.autoscrollTimer=0},QuestionView.prototype.el="#content",QuestionView.prototype.triggerChangeIn=function(e){var t,n,i,o,a;for(a=[],i=0,o=e.length;o>i;i++)n=e[i],t=[],t.push(window.questionCache[n].find("input, select, textarea, img")),a.push($(t).each(function(e){return function(t,n){var i;return i={target:n},e.actionOnChange(i)}}(this)));return a},QuestionView.prototype.render=function(){var autocompleteElements,skipperList;return this.$el.html("<style> .message { color: grey; font-weight: bold; padding: 10px; border: 1px yellow dotted; background: yellow; display: none; } label.radio { border-radius:20px; display:block; padding:4px 11px; border: 1px solid black; cursor: pointer; text-decoration: none; } input[type='radio']:checked + label { background-color:#ddd; background: #5393c5; background-image: -webkit-gradient(linear,left top,left bottom,from(#5393c5),to(#6facd5)); background-image: -webkit-linear-gradient(#5393c5,#6facd5); background-image: -moz-linear-gradient(#5393c5,#6facd5); background-image: -ms-linear-gradient(#5393c5,#6facd5); background-image: -o-linear-gradient(#5393c5,#6facd5); background-image: linear-gradient(#5393c5,#6facd5); } input[type='radio']{ height: 0px; } div.question.radio{ padding-top: 8px; padding-bottom: 8px; } .tt-hint{ display:none } .tt-dropdown-menu{ width: 100%; background-color: lightgray; } .tt-suggestion{ background-color: white; border-radius:20px; display:block; padding:4px 11px; border: 1px solid black; cursor: pointer; text-decoration: none; } .tt-suggestion .{ } </style> <div style='position:fixed; right:5px; color:white; padding:20px; z-index:5' id='messageText'> <a href='#help/"+this.model.id+"'>Help</a> </div> <div style='position:fixed; right:5px; color:white; background-color: #333; padding:20px; display:none; z-index:10' id='messageText'> Saving... </div> <h1>"+this.model.id+"</h1> <div id='question-view'> <form> "+this.toHTMLForm(this.model)+" </form> </div>"),js2form($("form").get(0),this.result.toJSON()),this.updateCache(),this.updateSkipLogic(),skipperList=[],$(this.model.get("questions")).each(function(){return function(e,t){return t.actionOnChange().match(/skip/i)&&skipperList.push(t.safeLabel()),null!=t.get("action_on_questions_loaded")&&""!==t.get("action_on_questions_loaded")?CoffeeScript.eval(t.get("action_on_questions_loaded")):void 0}}(this)),this.triggerChangeIn(skipperList),this.$el.find("input[type=text],input[type=number],input[type='autocomplete from previous entries'],input[type='autocomplete from list'],input[type='autocomplete from code']").textinput(),this.$el.find("input[type=checkbox]").checkboxradio(),this.$el.find("ul").listview(),this.$el.find("select").selectmenu(),this.$el.find("a").button(),this.$el.find("input[type=date]").datebox({mode:"calbox",dateFormat:"%d-%m-%Y"}),autocompleteElements=[],_.each($("input[type='autocomplete from list']"),function(e){return e=$(e),e.typeahead({local:e.attr("data-autocomplete-options").replace(/\n|\t/,"").split(/, */)}),autocompleteElements.push(e)}),_.each($("input[type='autocomplete from code']"),function(element){return element=$(element),element.typeahead({local:eval(element.attr("data-autocomplete-options"))}),autocompleteElements.push(element)}),_.each($("input[type='autocomplete from previous entries']"),function(e){return e=$(e),e.typeahead({prefetch:document.location.pathname.substring(0,document.location.pathname.indexOf("index.html"))+('_list/values/byValue?key="'+e.attr("name")+'"')}),autocompleteElements.push(e)}),_.each(autocompleteElements,function(e){return function(t){return t.blur(function(){return e.autoscroll(t)})}}(this)),this.readonly?$("input, textarea").attr("readonly","true"):void 0},QuestionView.prototype.events={"change #question-view input":"onChange","change #question-view select":"onChange","change #question-view textarea":"onChange","click #question-view button:contains(+)":"repeat","click #question-view a:contains(Get current location)":"getLocation","click .next_error":"runValidate","click .validate_one":"onValidateOne"},QuestionView.prototype.runValidate=function(){return this.validateAll()},QuestionView.prototype.onChange=function(e){var t,n,i,o;return t=$(e.target),n=t.attr("id"),n===this.oldStamp&&(new Date).getTime()<this.throttleTime+1e3?void 0:(this.throttleTime=(new Date).getTime(),this.oldStamp=n,o=t.attr("name"),"complete"===o?this.changedComplete?void(this.changedComplete=!1):(this.validateAll(),Coconut.menuView.update(),this.save(),this.updateSkipLogic(),this.actionOnChange(e)):(this.changedComplete=!1,i=window.questionCache[o].find(".message").is(":visible"),_.delay(function(t){return function(){var n;return!i&&(n=t.validateOne({key:o,autoscroll:!1,button:"<button type='button' data-name='"+o+"' class='validate_one'>Validate</button>"}),t.save(),t.updateSkipLogic(),t.actionOnChange(e),n)?t.autoscroll(e):void 0}}(this),500)))},QuestionView.prototype.onValidateOne=function(e){var t,n;return t=$(e.target),n=$(e.target).attr("data-name"),this.validateOne({key:n,autoscroll:!0,leaveMessage:!1,button:"<button type='button' data-name='"+n+"' class='validate_one'>Validate</button>"})},QuestionView.prototype.validateAll=function(){var e,t,n,i,o,a;for(e=!0,a=window.keyCache,i=0,o=a.length;o>i;i++)t=a[i],n=!this.validateOne({key:t,autoscroll:e,leaveMessage:!1}),e&&n&&(e=!1);return this.completeButton(e),e&&$("[name=complete]").parent().scrollTo(),e},QuestionView.prototype.validateOne=function(e){var t,n,i,o,a,r,s,u;r=e.key||"",i=e.autoscroll||!1,o=e.button||"<button type='button' class='next_error'>Next Error</button>",s=e.leaveMessage||!1,n=window.questionCache[r],t=n.find(".message");try{u=this.isValid(r)}catch(l){a=l,alert("isValid error in "+r+"\n"+a),u=""}return t.is(":visible")&&s?""===u?!0:!1:""===u?(t.hide(),i&&this.autoscroll(n),!0):(t.show().html(""+u+" "+o).find("button").button(),this.scrollToQuestion(n),!1)},QuestionView.prototype.isValid=function(e){var t,n,i,o,a,r,s,u,l,c,d;if(e){if(r=[],o=window.questionCache[e],o.hasClass("label"))return"";if(i=$("[name="+e+"]",o),s=$(o.find("input").get(0)).attr("type"),n="radio"===s?$("label[for="+i.attr("id").split("-")[0]+"]",o).text()||"":null!=(d=$("label[for="+i.attr("id")+"]",o))?d.text():void 0,a="true"===o.attr("data-required"),u=unescape(o.attr("data-validation")),"undefined"===u&&(u=null),c=window.getValueCache[e](),!o.is(":visible"))return"";if(0!==i.find("input").length&&("checkbox"===s||"radio"===s))return"";if(!a||""!==c&&null!==c||r.push("'"+n+"' is required."),null!=u&&""!==u)try{l=CoffeeScript.eval("(value) -> "+u,{bare:!0})(c),null!=l&&r.push(l)}catch(p){if(t=p,"invisible reference"===t)return"";alert("Validation error for "+e+" with value "+c+": "+t)}return 0!==r.length?r.join("<br>")+"<br>":""}},QuestionView.prototype.scrollToQuestion=function(e){return this.autoscroll($(e).prev())},QuestionView.prototype.autoscroll=function(e){var t,n,i;if(clearTimeout(this.autoscrollTimer),e.jquery?(t=e,window.scrollTargetName=t.attr("data-question-name")||t.attr("name")):(n=$(e.target),window.scrollTargetName=n.attr("name"),t=window.questionCache[window.scrollTargetName]),this.$next=t.next(),!this.$next.is(":visible")&&this.$next.length>0)for(i=0;!this.$next.is(":visible")&&(i+=1)<100;)this.$next=this.$next.next();if(this.$next.is(":visible")){if(window.questionCache[window.scrollTargetName].find(".message").is(":visible"))return;return $(window).on("scroll",function(e){return function(){return $(window).off("scroll"),clearTimeout(e.autoscrollTimer)}}(this)),this.autoscrollTimer=setTimeout(function(e){return function(){return $(window).off("scroll"),e.$next.scrollTo().find("input[type=text],input[type=number]").focus()}}(this),1e3)}},QuestionView.prototype.actionOnChange=function(e){var t,n,i,o,a,r,s,u,l;if(u=$(e.target).get(0).nodeName,n="INPUT"===u||"SELECT"===u||"TEXTAREA"===u?$(e.target):$(e.target).parent().parent().parent().find("input,textarea,select"),n.is(":visible")){r=n.attr("name"),t=$(".question [data-question-name="+r+"]"),i=t.attr("data-action_on_change");try{l=ResultOfQuestion(r)}catch(c){if(o=c,"invisible reference"===o)return}if(""!==i&&null!=i){i="(value) -> "+i;try{return(s=CoffeeScript.eval.apply(this,[i]))(l)}catch(c){return o=c,r=/function (.{1,})\(/.exec(o.constructor.toString())[1],a=o.message,alert("Action on change error in question "+(t.attr("data-question-id")||t.attr("id"))+"\n\n"+r+"\n\n"+a)}}}},QuestionView.prototype.updateSkipLogic=function(){var $question,error,message,name,result,skipLogicCode,_ref,_results;_ref=window.questionCache,_results=[];for(name in _ref)if($question=_ref[name],skipLogicCode=window.skipLogicCache[name],""!==skipLogicCode&&null!=skipLogicCode){try{result=eval(skipLogicCode)}catch(_error){error=_error,"invisible reference"===error?result=!0:(name=/function (.{1,})\(/.exec(error.constructor.toString())[1],message=error.message,alert("Skip logic error in question "+$question.attr("data-question-id")+"\n\n"+name+"\n\n"+message))}_results.push(result?$question[0].style.display="none":$question[0].style.display="")}return _results},QuestionView.prototype.save=_.throttle(function(){var e;return e=$("form").toObject({skipEmpty:!1}),e.lastModifiedAt=moment(new Date).format(Coconut.config.get("datetime_format")),e.savedBy=$.cookie("current_user"),this.result.save(e,{success:function(e){return function(t){var n;return $("#messageText").slideDown().fadeOut(),Coconut.router.navigate("edit/result/"+t.id,!1),Coconut.menuView.update(),e.result.complete()&&e.result.nextLevelCreated!==!0?(e.result.nextLevelCreated=!0,n=new Case({caseID:e.result.get("MalariaCaseID")}),n.fetch({error:function(e){return console.log(e)},success:function(){var t;switch(e.result.get("question")){case"Case Notification":if(!_(n.questions).contains("Facility"))return t=new Result({question:"Facility",MalariaCaseID:e.result.get("MalariaCaseID"),FacilityName:e.result.get("FacilityName"),Shehia:e.result.get("Shehia")}),t.save(null,{success:function(){return Coconut.menuView.update()}});break;case"Facility":if(!_(n.questions).contains("Household"))return t=new Result({question:"Household",MalariaCaseID:e.result.get("MalariaCaseID"),HeadofHouseholdName:e.result.get("HeadofHouseholdName"),Shehia:e.result.get("Shehia"),Village:e.result.get("Village"),ShehaMjumbe:e.result.get("ShehaMjumbe"),ContactMobilepatientrelative:e.result.get("ContactMobilepatientrelative")}),t.save(null,{success:function(){return Coconut.menuView.update()}});break;case"Household":if(!_(n.questions).contains("Household Members"))return _(e.result.get("TotalNumberofResidentsintheHousehold")-1).times(function(){return t=new Result({question:"Household Members",MalariaCaseID:e.result.get("MalariaCaseID"),HeadofHouseholdName:e.result.get("HeadofHouseholdName")}),t.save(null,{success:function(){return Coconut.menuView.update()}})})}}})):void 0}}(this)})},1e3),QuestionView.prototype.completeButton=function(e){return this.changedComplete=!0,$("[name=complete]").prop("checked")!==e?$("[name=complete]").click():void 0},QuestionView.prototype.toHTMLForm=function(e,t){return null==e&&(e=this.model),window.skipLogicCache={},null==e.length&&(e=[e]),_.map(e,function(e){return function(n){var i,o,a,r,s,u,l,c;return c="true"===n.repeatable()?"<button>+</button>":"",null!=n.type()&&null!=n.label()&&""!==n.label()?(a=n.safeLabel(),window.skipLogicCache[a]=""!==n.skipLogic()?CoffeeScript.compile(n.skipLogic(),{bare:!0}):"",l=n.get("id"),"true"===n.repeatable()&&(a+="[0]",l=n.get("id")+"-0"),null!=t&&(a="group."+t+"."+a),"<div "+(n.validation()?n.validation()?"data-validation = '"+escape(n.validation())+"'":void 0:"")+" data-required='"+n.required()+"' class='question "+(("function"==typeof n.type?n.type():void 0)||"")+"' data-question-name='"+a+"' data-question-id='"+l+"' data-action_on_change='"+_.escape(n.actionOnChange())+"' > "+(~n.type().indexOf("hidden")?void 0:"<label type='"+n.type()+"' for='"+l+"'>"+n.label()+" <span></span></label>")+" <div class='message'></div> "+function(){var e,t,r;switch(n.type()){case"textarea":return"<input name='"+a+"' type='text' id='"+l+"' value='"+_.escape(n.value())+"'></input>";case"select":if(this.readonly)return n.value();for(i="<select>",r=n.get("select-options").split(/, */),o=e=0,t=r.length;t>e;o=++e)s=r[o],i+="<option name='"+a+"' id='"+l+"-"+o+"' value='"+s+"'>"+s+"</option>";return i+="</select>";case"radio":return this.readonly?"<input class='radioradio' name='"+a+"' type='text' id='"+l+"' value='"+n.value()+"'></input>":(u=n.get("radio-options"),_.map(u.split(/, */),function(e,t){return"<input class='radio' type='radio' name='"+a+"' id='"+l+"-"+t+"' value='"+_.escape(e)+"'/> <label class='radio' for='"+l+"-"+t+"'>"+e+"</label> <!-- <div class='ui-radio'> <label for=''"+l+"-"+t+"' data-corners='true' data-shadow='false' data-iconshadow='true' data-wrapperels='span' data-icon='radio-off' data-theme='c' class='ui-btn ui-btn-corner-all ui-btn-icon-left ui-radio-off ui-btn-up-c'> <span class='ui-btn-inner ui-btn-corner-all'> <span class='ui-btn-text'>"+e+"</span> <span class='ui-icon ui-icon-radio-off ui-icon-shadow'>&nbsp;</span> </span> </label> <input type='radio' name='"+a+"' id='"+l+"-"+t+"' value='"+_.escape(e)+"'/> </div> -->"}).join(""));case"checkbox":return this.readonly?"<input name='"+a+"' type='text' id='"+l+"' value='"+_.escape(n.value())+"'></input>":"<input style='display:none' name='"+a+"' id='"+l+"' type='checkbox' value='true'></input>";case"autocomplete from list":case"autocomplete from previous entries":case"autocomplete from code":return"<!-- autocomplete='off' disables browser completion --> <input autocomplete='off' name='"+a+"' id='"+l+"' type='"+n.type()+"' value='"+n.value()+"' data-autocomplete-options='"+n.get("autocomplete-options")+"'></input> <ul id='"+l+"-suggestions' data-role='listview' data-inset='true'/>";case"location":return this.watchID=navigator.geolocation.getAccurateCurrentPosition(function(){},function(){},function(){},{desiredAccuracy:50,maxWait:3e5}),"<a data-question-id='"+l+"'>Get current location</a> <label for='"+l+"-description'>Location Description</label> <input type='text' name='"+a+"-description' id='"+l+"-description'></input> "+_.map(["latitude","longitude","accuracy"],function(e){return"<label for='"+l+"-"+e+"'>"+e+"</label><input readonly='readonly' type='number' name='"+a+"-"+e+"' id='"+l+"-"+e+"'></input>"}).join("")+" "+_.map(["altitude","altitudeAccuracy","heading","timestamp"],function(e){return"<input type='hidden' name='"+a+"-"+e+"' id='"+l+"-"+e+"'></input>"}).join("");case"image":return"<img style='"+n.get("image-style")+"' src='"+n.get("image-path")+"'/>";case"label":return"";default:return"<input name='"+a+"' id='"+l+"' type='"+n.type()+"' value='"+n.value()+"'></input>"}}.call(e)+" </div> "+c):(r=l,n.repeatable()&&(r+="[0]"),"<div data-group-id='"+l+"' class='question group'>"+e.toHTMLForm(n.questions(),r)+"</div>"+c)}}(this)).join("")},QuestionView.prototype.updateCache=function(){var e,t,n,i,o,a,r,s,u,l;for(window.questionCache={},window.getValueCache={},window.$questions=$(".question"),l=window.$questions,s=0,u=l.length;u>s;s++)o=l[s],i=o.getAttribute("data-question-name"),null!=i&&""!==i&&(t={},window.questionCache[i]=$(o),e=window.questionCache[i],a=$("select[name="+i+"]",e),0===a.length?(n=$("input[name="+i+"]",e),0!==n.length?(r=n[0].getAttribute("type"),"radio"===r?!function(e,n){return t=function(){return $("input:checked",n).safeVal()}}(i,e):"checkbox"===r?!function(e,n){return t=function(){return $("input",n).map(function(){return $(this).safeVal()})}}(i,e):!function(e){return t=function(){return e.safeVal()}}(n)):!function(e,n){return t=function(){return $(".textarea[name="+e+"]",n).safeVal()}}(i,e)):!function(e){return t=function(){return e.safeVal()}}(a),window.getValueCache[i]=t);return window.keyCache=_.keys(questionCache)},QuestionView.prototype.repeat=function(e){var t,n,i,o,a,r,s,u,l,c;for(t=$(e.target),a=t.prev(".question").clone(),r=a.attr("data-group-id"),null==r&&(r=""),c=a.find("input"),u=0,l=c.length;l>u;u++)n=c[u],n=$(n),i=n.attr("name"),s=new RegExp(""+r+"\\[(\\d)\\]"),o=parseInt(_.last(i.match(s)))+1,n.attr("name",i.replace(s,""+r+"["+o+"]"));return t.after(a.add(t.clone())),t.remove()},QuestionView.prototype.getLocation=function(e){var t,n,i,o,a,r,s;return r=200,t=18e4,a=$(e.target).closest("[data-question-id]").attr("data-question-id"),$("#"+a+"-description").val("Retrieving position, please wait."),s=function(e){return _.each(e.coords,function(e,t){return $("#"+a+"-"+t).val(e)}),$("#"+a+"-timestamp").val(moment(e.timestamp).format(Coconut.config.get("datetime_format"))),$.getJSON("http://api.geonames.org/findNearbyPlaceNameJSON?lat="+e.coords.latitude+"&lng="+e.coords.longitude+"&username=mikeymckay&callback=?",null,function(){return function(e){return $("#"+a+"-description").val(parseFloat(e.geonames[0].distance).toFixed(1)+" km from center of "+e.geonames[0].name)}}(this))},o=function(e){return function(t){return $("label[type=location]").html("Household Location"),s(t),$("#"+a+"-description").val("Success"),e.save()}}(this),n=function(e){return $("#"+a+"-description").val("Error: "+JSON.stringify(e))},i=function(){return function(e){return s(e),$("label[type=location]").html("Household Location<div style='background-color:yellow'>Current accuracy is "+e.coords.accuracy+" meters - must be less than "+r+" meters. Make sure there are no trees or buildings blocking view to the sky.</div>")}}(this),navigator.geolocation.clearWatch(this.watchID),navigator.geolocation.getAccurateCurrentPosition(o,n,i,{desiredAccuracy:r,maxWait:t})},QuestionView}(Backbone.View),function(e){return e.fn.scrollTo=function(t,n){var i;null==t&&(t=500);try{e("html, body").animate({scrollTop:e(this).offset().top+"px"},t,null,n)}catch(o){i=o,console.log("error",i),console.log("Scroll error with 'this'",this)}return this},e.fn.safeVal=function(){return this.is(":visible")||this.parents(".question").filter(function(){return!e(this).hasClass("group")}).is(":visible")?e.trim(this.val()||""):null}}($);
var ResultsView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function o(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};ResultsView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.question=new Question},e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<style> table.results th.header, table.results td{ font-size:150%; } .dataTables_wrapper .dataTables_length{ display: none; } .dataTables_filter input{ display:inline; width:300px; } a[role=button]{ background-color: white; margin-right:5px; -moz-border-radius: 1em; -webkit-border-radius: 1em; border: solid gray 1px; font-family: Helvetica,Arial,sans-serif; font-weight: bold; color: #222; text-shadow: 0 1px 0 #fff; -webkit-background-clip: padding-box; -moz-background-clip: padding; background-clip: padding-box; padding: .6em 20px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; position: relative; zoom: 1; } a[role=button].paginate_disabled_previous, a[role=button].paginate_disabled_next{ color:gray; } .dataTables_info{ float:right; } .dataTables_paginate{ margin-bottom:20px; } </style> <a href='#new/result/"+escape(this.question.id)+"'>Add new '"+this.question.id+"'</a> <div class='not-complete' data-collapsed='false' data-role='collapsible'> <h2>'"+this.question.id+"' Items Not Completed (<span class='count-complete-false'></span>)</h2> <table class='results complete-false tablesorter'> <thead><tr>"+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+"<th></th> </tr></thead> <tbody> </tbody> <tfoot><tr>"+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+("<th></th> </tr></tfoot> </table> </div> <div class='complete' data-role='collapsible'> <h2>'"+this.question.id+"' Items Completed (or transferred out) (<span class='count-complete-true'></span>)</h2> <table class='results complete-true tablesorter'> <thead><tr>")+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+"<th></th> </tr></thead> <tbody> </tbody> <tfoot><tr>"+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+"<th></th> </tr></tfoot> </table> </div>"),$("a").button(),$("[data-role=collapsible]").collapsible(),$(".complete").bind("expand",function(t){return function(){return t.loadResults(!0)}}(this)),this.loadResults(!1),this.updateCountComplete()},e.prototype.updateCountComplete=function(){var t;return console.log("ZZZ"),t=new ResultCollection,t.fetch({question:this.question.id,isComplete:!0,success:function(){return function(){return $(".count-complete-true").html(t.results.length)}}(this)})},e.prototype.loadResults=function(t){var e;return e=new ResultCollection,e.fetch({include_docs:"true",question:this.question.id,isComplete:t,success:function(o){return function(){return $(".count-complete-"+t).html(e.results.length),e.each(function(n,a){return"true"!==t&&n.wasTransferredOut()?void $(".count-complete-"+t).html(parseInt($(".count-complete-"+t).html())-1):($("table.complete-"+t+" tbody").append("<tr> "+_.map(n.summaryValues(o.question),function(t){return"<td><a href='#edit/result/"+n.id+"'>"+t+"</a></td>"}).join("")+" <td><a href='#delete/result/"+n.id+"' data-icon='delete' data-iconpos='notext'>Delete</a></td> </tr>"),a+1===e.length&&($("table a").button(),$("table").trigger("update")),_.each($("table tr"),function(t,e){return e%2===1?$(t).addClass("odd"):void 0}))}),$("table").dataTable(),$(".dataTables_filter input").textinput()}}(this)})},e}(Backbone.View);
var SyncView,__bind=function(t,n){return function(){return t.apply(n,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,n){function e(){this.constructor=t}for(var s in n)__hasProp.call(n,s)&&(t[s]=n[s]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};SyncView=function(t){function n(){return this.update=__bind(this.update,this),this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.initialize=function(){return this.sync=new Sync},n.prototype.el="#content",n.prototype.render=function(){return this.$el.html(""),$("#log").html("")},n.prototype.update=function(){return this.sync.fetch({success:function(t){return function(){return $(".sync-sent-status").html(t.sync.was_last_send_successful()?t.sync.last_send_time():""+t.sync.last_send_time()+" - last attempt FAILED"),$(".sync-get-status").html(t.sync.was_last_get_successful()?t.sync.last_get_time():""+t.sync.last_get_time()+" - last attempt FAILED")}}(this),error:function(t){return function(){return console.log("synclog doesn't exist yet, create it and re-render"),t.sync.save(),_.delay(t.update,1e3)}}(this)})},n}(Backbone.View);
var Coconut,Router,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function n(){this.constructor=e}for(var o in t)__hasProp.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};Router=function(e){function t(){return this.userWithRoleLoggedIn=__bind(this.userWithRoleLoggedIn,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.routes={login:"login",logout:"logout","show/results/:question_id":"showResults","new/result/:question_id":"newResult","show/result/:result_id":"showResult","edit/result/:result_id":"editResult","delete/result/:result_id":"deleteResult","delete/result/:result_id/:confirmed":"deleteResult","reset/database":"resetDatabase",sync:"sync","sync/send":"syncSend","sync/get":"syncGet",configure:"configure",help:"help","help/:helpDocument":"help","csv/:question/startDate/:startDate/endDate/:endDate":"csv","":"default"},t.prototype.route=function(e,t,n){return Backbone.history||(Backbone.history=new Backbone.History),_.isRegExp(e)||(e=this._routeToRegExp(e)),Backbone.history.route(e,function(o){return function(u){var r;return r=o._extractParameters(e,u),n.apply(o,r),$("#loading").slideDown(),o.trigger.apply(o,["route:"+t].concat(r)),$("#loading").fadeOut()}}(this),this)},t.prototype.userLoggedIn=function(e){return User.isAuthenticated({success:function(t){return e.success(t)},error:function(){return Coconut.loginView.callback=e,Coconut.loginView.render()}})},t.prototype.csv=function(e,t,n){return this.userLoggedIn({success:function(){var o;return User.currentUser.hasRole("reports")?(o=new CsvView,o.question=e,o.startDate=n,o.endDate=t,o.render()):void 0}})},t.prototype.help=function(e){return this.userLoggedIn({success:function(){return null==Coconut.helpView&&(Coconut.helpView=new HelpView),Coconut.helpView.helpDocument=null!=e?e:null,Coconut.helpView.render()}})},t.prototype.login=function(){return Coconut.loginView.callback={success:function(){return Coconut.router.navigate("",!0)}},Coconut.loginView.render()},t.prototype.userWithRoleLoggedIn=function(e,t){return this.userLoggedIn({success:function(n){return n.hasRole(e)?t.success(n):$("#content").html("<h2>User '"+n.username()+"' must have role: '"+e+"'</h2>")},error:function(){return $("#content").html("<h2>User '"+user.username()+"' must have role: '"+e+"'</h2>")}})},t.prototype.adminLoggedIn=function(e){return this.userLoggedIn({success:function(t){return t.isAdmin()?e.success(t):void 0},error:function(){return $("#content").html("<h2>Must be an admin user</h2>")}})},t.prototype.logout=function(){return User.logout(),Coconut.router.navigate("",!0),document.location.reload()},t.prototype["default"]=function(){return this.userLoggedIn({success:function(){return User.currentUser.hasRole("reports")&&Coconut.router.navigate("reports",!0),$("#content").html("")}})},t.prototype.configure=function(){return this.userLoggedIn({success:function(){return null==Coconut.localConfigView&&(Coconut.localConfigView=new LocalConfigView),Coconut.localConfigView.render()}})},t.prototype.editQuestion=function(e){return this.userLoggedIn({success:function(){return null==Coconut.designView&&(Coconut.designView=new DesignView),Coconut.designView.render(),Coconut.designView.loadQuestion(unescape(e))}})},t.prototype.deleteQuestion=function(e){return this.userLoggedIn({success:function(){return Coconut.questions.get(unescape(e)).destroy({success:function(){return Coconut.menuView.render(),Coconut.router.navigate("manage",!0)}})}})},t.prototype.syncSend=function(){return Coconut.router.navigate("",!1),this.userLoggedIn({success:function(){return null==Coconut.syncView&&(Coconut.syncView=new SyncView),Coconut.syncView.render(),Coconut.syncView.sync.sendToCloud({success:function(){return Coconut.syncView.update()},error:function(){return Coconut.syncView.update()}})}})},t.prototype.syncGet=function(){return Coconut.router.navigate("",!1),this.userLoggedIn({success:function(){return null==Coconut.syncView&&(Coconut.syncView=new SyncView),Coconut.syncView.render(),Coconut.syncView.sync.getFromCloud()}})},t.prototype.manage=function(){return this.adminLoggedIn({success:function(){return null==Coconut.manageView&&(Coconut.manageView=new ManageView),Coconut.manageView.render()}})},t.prototype.newResult=function(e){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.result=new Result({question:unescape(e)}),Coconut.questionView.model=new Question({id:unescape(e)}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render()}})}})},t.prototype.showResult=function(e){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.readonly=!0,Coconut.questionView.result=new Result({_id:e}),Coconut.questionView.result.fetch({success:function(){var e;return e=Coconut.questionView.result.question(),null!=e?(Coconut.questionView.model=new Question({id:e}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render()}})):($("#content").html("<button id='delete' type='button'>Delete</button> <pre>"+JSON.stringify(Coconut.questionView.result,null,2)+"</pre>"),$("button#delete").click(function(){return confirm("Are you sure you want to delete this result?")?Coconut.questionView.result.destroy({success:function(){return $("#content").html("Result deleted, redirecting..."),_.delay(function(){return Coconut.router.navigate("/",!0)},2e3)}}):void 0}))}})}})},t.prototype.editResult=function(e){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.readonly=!1,Coconut.questionView.result=new Result({_id:e}),Coconut.questionView.result.fetch({success:function(){var e;return e=Coconut.questionView.result.question(),null!=e?(Coconut.questionView.model=new Question({id:e}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render()}})):($("#content").html("<button id='delete' type='button'>Delete</button> <br/> (Editing not supported for USSD Notifications) <br/> <pre>"+JSON.stringify(Coconut.questionView.result,null,2)+"</pre>"),$("button#delete").click(function(){return confirm("Are you sure you want to delete this result?")?Coconut.questionView.result.destroy({success:function(){return $("#content").html("Result deleted, redirecting..."),_.delay(function(){return Coconut.router.navigate("/",!0)},2e3)}}):void 0}))}})}})},t.prototype.deleteResult=function(e,t){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.readonly=!0,Coconut.questionView.result=new Result({_id:e}),Coconut.questionView.result.fetch({success:function(){var n;return n=Coconut.questionView.result.question(),null!=n?"confirmed"===t?Coconut.questionView.result.destroy({success:function(){return Coconut.menuView.update(),Coconut.router.navigate("show/results/"+escape(Coconut.questionView.result.question()),!0)}}):(Coconut.questionView.model=new Question({id:n}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render(),$("#content").prepend("<h2>Are you sure you want to delete this result?</h2> <div id='confirm'> <a href='#delete/result/"+e+"/confirmed'>Yes</a> <a href='#show/results/"+escape(Coconut.questionView.result.question())+"'>Cancel</a> </div>"),$("#confirm a").button(),$("#content form").css({"background-color":"#333",margin:"50px",padding:"10px"}),$("#content form label").css({color:"white"})}})):Coconut.router.navigate("edit/result/"+e,!0)}})}})},t.prototype.showResults=function(e){return this.userLoggedIn({success:function(){return null==Coconut.resultsView&&(Coconut.resultsView=new ResultsView),Coconut.resultsView.question=new Question({id:unescape(e)}),Coconut.resultsView.question.fetch({success:function(){return Coconut.resultsView.render()}})}})},t.prototype.resetDatabase=function(){return this.userLoggedIn({success:function(){return confirm("Are you sure you want to reset the database? All data that has not yet been sent to the cloud will be lost.")?database.destroy(function(){return Coconut.router.navigate("",!0),document.location.reload()}):void 0}})},t.prototype.startApp=function(){return Coconut.config=new Config,Coconut.config.fetch({success:function(){var e,t;return"cloud"===Coconut.config.local.get("mode")&&$("body").append("<style> .leaflet-map-pane { z-index: 2 !important; } .leaflet-google-layer { z-index: 1 !important; } </style>"),$("#footer-menu").html("<center> <span style='font-size:75%;display:inline-block'> <span id='district'></span><br/> <span id='user'></span> </span> <a href='#login'>Login</a> <a href='#logout'>Logout</a> "+("cloud"===Coconut.config.local.get("mode")?"<a id='reports-button' href='#reports'>Reports</a>":"<a href='#sync/send'>Send data (last success: <span class='sync-sent-status'></span>)</a> <a href='#sync/get'>Get data (last success: <span class='sync-get-status'></span>)</a> <a href='#reset/database'>Reset database</a>")+" &nbsp; <a id='manage-button' style='display:none' href='#manage'>Manage</a> &nbsp; <a href='#help'>Help</a> <span style='font-size:75%;display:inline-block'>Version<br/><span id='version'></span></span> <span style='font-size:75%;display:inline-block'><br/><span id='databaseStatus'></span></span> </center>"),$("[data-role=footer]").navbar(),$("#application-title").html(Coconut.config.title()),e=[UserCollection,ResultCollection],t=_.after(e.length,function(){return Coconut.loginView=new LoginView,Coconut.questionView=new QuestionView,Coconut.menuView=new MenuView,Coconut.syncView=new SyncView,Coconut.menuView.render(),Coconut.syncView.update(),Backbone.history.start()}),QuestionCollection.load({error:function(e){return alert("Could not load "+ClassToLoad+": "+e+". Recommendation: Press get data again.")},success:function(){return _.each(e,function(e){return e.load({success:function(){return t()},error:function(n){return alert("Could not load "+e+": "+n+". Recommendation: Press get data again."),t()}})})}})},error:function(){return null==Coconut.localConfigView&&(Coconut.localConfigView=new LocalConfigView),Coconut.localConfigView.render()}})},t}(Backbone.Router),Coconut={},Coconut.router=new Router,database.get("_local/initial_load_complete",function(e){var t,n;if(e){if(404!==e.status)throw e;return t=prompt("Enter cloud URL","http://mikeymckay.iriscouch.com"),t=t.replace(/http:\/\//,""),Coconut.config=new Config({cloud:t,cloud_database_name:prompt("Enter application name"),cloud_credentials:""+prompt("Enter cloud username","admin")+":"+prompt("Enter cloud password","admin")}),n=new Sync,n.replicateApplicationDocs({error:function(e){return console.error("Updating application docs failed: "+JSON.stringify(e))},success:function(){return database.put({_id:"_local/initial_load_complete"},function(e){return e?console.log(e):void 0}),Coconut.router.startApp(),_.delay(function(){return $("#log").html("")},5e3)}})}return appCacheNanny.start(),Coconut.router.startApp()}),Coconut.debug=function(e){return console.log(e),$("#log").append(e+"<br/>")};